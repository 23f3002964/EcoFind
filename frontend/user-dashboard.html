<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EcoFinds - User Dashboard</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/frontend/static/js/utils.js"></script> <!-- Added global utils script -->
</head>
<body class="bg-gray-50 min-h-screen">

<header class="bg-white shadow-sm py-4 px-4 md:px-6">
    <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
        <!-- Logo -->
        <div class="flex items-center">
            <a href="/frontend/products.html">
                <img src="/frontend/logo.png" alt="EcoFinds Logo" class="h-10 md:h-12 w-auto">
            </a>
        </div>

        <!-- Navigation Links -->
        <nav class="flex flex-wrap justify-center md:justify-start gap-x-4 gap-y-2">
            <a href="/frontend/products.html" class="text-gray-700 hover:text-green-600 px-3 py-2 rounded-md text-sm font-medium transition-colors">Products</a>
            <a href="/frontend/my-listings.html" class="text-gray-700 hover:text-green-600 px-3 py-2 rounded-md text-sm font-medium transition-colors">My Listings</a>
            <a href="/frontend/cart.html" class="text-gray-700 hover:text-green-600 px-3 py-2 rounded-md text-sm font-medium transition-colors">Cart</a>
            <a href="/frontend/user-dashboard.html" class="text-gray-700 hover:text-green-600 px-3 py-2 rounded-md text-sm font-medium transition-colors">Profile</a>
        </nav>

        <!-- Logout Button -->
        <div>
            <button onclick="performLogout()" class="bg-red-500 hover:bg-red-700 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors">
                Logout
            </button>
        </div>
    </div>
</header>

<!-- Global Logout Script -->
<script>
    async function performLogout() {
        try {
            const response = await fetch('/api/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            if (response.ok) {
                window.location.href = '/frontend/login.html';
            } else {
                const data = await response.json();
            showGlobalToast(data.message || 'Logout failed. Please try again.', true);
                console.error('Logout failed:', data);
            }
        } catch (error) {
        showGlobalToast('An error occurred during logout. Please check your connection and try again.', true);
            console.error('Error during logout:', error);
        }
    }
</script>

  <!-- Standardized Loading Indicator -->
  <div v-if="loading" class="fixed inset-0 bg-gray-100 bg-opacity-75 flex items-center justify-center z-50">
    <div class="flex items-center justify-center p-6 rounded-lg space-x-3">
        <svg class="animate-spin h-10 w-10 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-xl text-gray-700">Loading...</span>
    </div>
  </div>

  <div id="app" class="max-w-3xl mx-auto p-6 pt-12"> <!-- Added pt-12 for spacing -->
    <!-- Profile Section -->
    <div class="bg-white rounded shadow p-6">
      <div class="flex items-center space-x-4 mb-6">
        <img src="/user-placeholder.svg" alt="User Image" class="w-20 h-20 rounded-full border" />
        <h2 class="text-2xl font-semibold text-gray-800">Your Profile</h2>
      </div>

      <form @submit.prevent="updateProfile" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="first_name" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
              <input id="first_name" v-model="user.first_name" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" />
            </div>
            <div>
              <label for="last_name" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
              <input id="last_name" v-model="user.last_name" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" />
            </div>
        </div>
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
          <input id="username" v-model="user.username" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required />
        </div>
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input id="email" type="email" v-model="user.email" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" required />
        </div>
        <div>
          <label for="phone_number" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
          <input id="phone_number" v-model="user.phone_number" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" />
        </div>
        <div>
          <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
          <input id="address" v-model="user.address" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" />
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-gray-700 mb-1">New Password (leave blank to keep current)</label>
          <input id="password" type="password" v-model="user.password" placeholder="••••••••" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" />
        </div>
        <div class="pt-2">
          <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all duration-300 ease-in-out">
            Update Profile
          </button>
        </div>
      </form>

      <!-- Message display removed, will use global toast -->
    </div>
  </div>

  <script>
    const { createApp } = Vue;
    createApp({
      data() {
        return {
          user: {},
          loading: true, // Default to true to show loader on initial mount
          // message and success properties removed
        };
      },
      methods: {
        async fetchUser() {
          this.loading = true;
          try {
            const res = await fetch('http://127.0.0.1:5000/api/user', { credentials: 'include' });
            if (res.status === 401) {
                showGlobalToast("Your session has expired. Please login again.", true);
                setTimeout(() => { window.location.href = '/frontend/login.html'; }, 2000);
                return;
            }
            if (!res.ok) {
                const errorData = await res.json().catch(() => ({}));
                throw new Error(errorData.error || `Failed to load user data (status: ${res.status})`);
            }
            const data = await res.json();
            this.user = data.user || {};
          } catch (err) {
            showGlobalToast(err.message || "A network error occurred while fetching user data.", true);
          } finally {
            this.loading = false;
          }
        },
        async updateProfile() {
          this.loading = true;
          // Clear password field if it's empty before sending, to avoid accidentally clearing it
          let userData = { ...this.user };
          if (userData.password === '') {
            delete userData.password;
          }

          try {
            const res = await fetch('http://127.0.0.1:5000/api/user/profile', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(userData)
            });
            const data = await res.json();
            if (res.ok) {
              showGlobalToast(data.message || 'Profile updated successfully!');
              this.user = data.user; // Re-assign user data from response to reflect any backend changes
              if (userData.password) { 
                this.user.password = ''; // Clear password from form if it was part of the update
              }
            } else {
              showGlobalToast(data.error || 'Failed to update profile.', true);
            }
          } catch (err) {
            showGlobalToast('A network error occurred. Failed to update profile.', true);
          } finally {
            this.loading = false;
          }
        }
        // Removed logout method as it's handled by the global performLogout()
      },
      mounted() {
        this.fetchUser();
      }
    }).mount('#app');
  </script>
</body>
</html>
